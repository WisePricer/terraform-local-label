version: 2

jobs:
  build:
    docker:
      - image: hashicorp/terraform:0.11.2
        entrypoint: /bin/sh
    steps:
      - checkout
      - run:
          name: "Validate tf files (terraform validate)"
          command: |
              find . -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (terraform validate -check-variables=false "$m" && echo "âˆš $m") || exit 1 ; done
      - run:
          name: "Check: Terraform formatting (terraform fmt)"
          command: |
              if [ `terraform fmt --list=true -diff=true -write=false | tee format-issues | wc -c` -ne 0 ]; then
                echo "Some terraform files need be formatted, run 'terraform fmt' to fix"
                echo "Formatting issues:"
                cat format-issues
                exit 1
              fi
      - run:
          name: "Install: tflint"
          command: |
              apk add wget
              wget https://github.com/wata727/tflint/releases/download/v0.5.4/tflint_linux_amd64.zip
              unzip tflint_linux_amd64.zip
              mkdir -p /usr/local/tflint/bin
              # TODO: CircleCI write to file for later run steps
              #export PATH=/usr/local/tflint/bin:$PATH
              echo "Installing tflint..."
              install tflint /usr/local/tflint/bin
              echo "Configuring tflint..."
              which awk
              which cut
              #awk --help
              which head
              head --help
              tail --help
              which terraform
              # head works but with non 0 exit ??
              terraform version | sed -n '1p;1q'
              terraform version | awk 'FNR <= 1'
              terraform version | awk 'NR==1'
              terraform version | read X
              echo "Got: $X"
              # awk and cut work
              echo "test v111" | awk -Fv -e '{ print $2 }'
              echo "test v111" | cut -dv -f2

              # FIX: line failing with code 141
              #tf_ver=$(terraform version | head -n 1 | cut -dv -f2)
              #tf_ver=$(terraform version | head -n 1 | awk -Fv '{ print $2 }')
              echo -e "\tConfig for terraform version: ${tf_ver}"
              #if [ -f '.tflint.hcl' ]; then
              #  sed -i "/terraform_version =/s/\".*\"/\"${tf_ver}\"/" .tflint.hcl
              #else
              #  echo -e "config {\nterraform_version = \"${tf_ver}\"\ndeep_check = true\n}" > .tflint.hcl
              #fi
      - run:
          # Not supporting modules from registry ?? v0.5.4
          # For now, must ignore in config file
          name: "Check: tflint"
          command: |
              #echo "Initializing terraform..."
              #terraform init -input=false
              echo "Running tflint..."
              /usr/local/tflint/bin/tflint --version
              /usr/local/tflint/bin/tflint

workflows:
  version: 2
  build:
    jobs:
      - build
